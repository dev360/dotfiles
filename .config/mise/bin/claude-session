#!/usr/bin/env bash
# Starts a nested zellij session with Claude
# Usage: claude-session <session-name> [--resume] [claude-args...]

SESSION_NAME="${1:-}"
shift

if [[ -z "$SESSION_NAME" ]]; then
    echo "Usage: claude-session <session-name> [--resume] [claude-args...]"
    exit 1
fi

# Parse args
RESUME_MODE=false
PROMPT=""
AGENT=""
CLAUDE_ARGS=""
while [[ $# -gt 0 ]]; do
    case "$1" in
        --resume)
            RESUME_MODE=true
            shift
            ;;
        --prompt)
            PROMPT="$2"
            shift 2
            ;;
        --agent)
            AGENT="$2"
            shift 2
            ;;
        *)
            CLAUDE_ARGS="$CLAUDE_ARGS $1"
            shift
            ;;
    esac
done

# Add agent to claude args if specified
if [[ -n "$AGENT" ]]; then
    CLAUDE_ARGS="$CLAUDE_ARGS --agent $AGENT"
fi

# Create a temp layout file for this session
LAYOUT_FILE="/tmp/claude-${SESSION_NAME}.kdl"

if [[ "$RESUME_MODE" == "true" ]]; then
    INIT_CMD="/resume ${SESSION_NAME}"
else
    INIT_CMD="/clear"
    RENAME_CMD="/rename ${SESSION_NAME}"
    # Escape single quotes in prompt for bash -c string
    ESCAPED_PROMPT="$(echo "$PROMPT" | sed "s/'/'\\\\''/g")"
fi

# Build the prompt command if we have one (only in clear mode)
PROMPT_CMD=""
if [[ "$RESUME_MODE" != "true" && -n "$PROMPT" ]]; then
    PROMPT_CMD=" && sleep 0.5 && zellij action write-chars '${ESCAPED_PROMPT}' && zellij action write 13"
fi

# Generate layout that runs claude with auto-init (no UI for nested session)
# close_on_exit=true ensures the pane closes when claude exits
# We don't use 'exec' so that cleanup runs after claude exits
cat > "$LAYOUT_FILE" << EOF
layout {
    default_tab_template {
        children
    }
    pane borderless=true close_on_exit=true {
        command "bash"
        args "-c" "(sleep 2 && zellij action write-chars '${INIT_CMD}' && zellij action write 13${RENAME_CMD:+ && sleep 0.5 && zellij action write-chars '${RENAME_CMD}' && zellij action write 13}${PROMPT_CMD}) & claude ${CLAUDE_ARGS}; zellij kill-session ${SESSION_NAME} 2>/dev/null"
    }
}
EOF

# Attach to existing session, or create new with layout if it doesn't exist
# First try to attach (will succeed if session exists)
zellij a "$SESSION_NAME" 2>/dev/null && exit 0

# Session doesn't exist - create new with layout
exec zellij --new-session-with-layout "$LAYOUT_FILE" -s "$SESSION_NAME"
