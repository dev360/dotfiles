#!/usr/bin/env bash
#MISE description="Start a Claude development session in a worktree"
#MISE usage="worktree:dev [branch-or-dir] [--new] [--orchestrator] [--pane] [--prompt ['...']] [--agent <name>]"
set -euo pipefail

# Use MISE_ORIGINAL_CWD if available (mise runs global tasks from $HOME)
ORIGINAL_CWD="${MISE_ORIGINAL_CWD:-$PWD}"
cd "$ORIGINAL_CWD"

# Parse arguments
TARGET=""
NEW=false
ORCHESTRATOR=false
# Use WORKTREE_* env vars as defaults if set
PANE="${WORKTREE_PANE:-false}"
DANGEROUS=false
WITH_VIM="${WORKTREE_VIM:-false}"
RESUME=false
USE_PROMPT=false
PROMPT=""
AGENT=""

while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help)
            cat <<EOF
Usage: mise worktree:dev [branch-or-dir] [options]

Start a Claude development session in a git worktree.

Options:
  --new          Create the worktree first if it doesn't exist
  --orchestrator Split view with two Claude instances (implementer + orchestrator)
  --pane         Side-by-side vim + claude in one tab (requires --vim, 2/3 + 1/3 split)
  --vim          Include a vim tab in the layout
  --prompt [MSG] Auto-send a prompt (defaults to "Work on <branch>" if no message)
  --agent NAME   Use a specific Claude agent
  --resume       Resume the previous Claude session
  --dangerous    Skip Claude permission prompts

Examples:
  mise worktree:dev                           # Dev session in current worktree
  mise worktree:dev feat/FLO-123              # Dev session for specific branch
  mise worktree:dev feat/FLO-123 --new        # Create worktree and start session
  mise worktree:dev --vim --pane --prompt     # Vim + Claude side-by-side
EOF
            exit 0
            ;;
        --new)
            NEW=true
            shift
            ;;
        --orchestrator)
            ORCHESTRATOR=true
            shift
            ;;
        --pane)
            PANE=true
            shift
            ;;
        --dangerous)
            DANGEROUS=true
            shift
            ;;
        --vim)
            WITH_VIM=true
            shift
            ;;
        --resume)
            RESUME=true
            shift
            ;;
        --prompt)
            USE_PROMPT=true
            # Check if next arg exists and isn't another flag
            if [[ -n "${2:-}" && "${2:0:1}" != "-" ]]; then
                PROMPT="$2"
                shift 2
            else
                shift
            fi
            ;;
        --agent)
            AGENT="$2"
            shift 2
            ;;
        -*)
            echo "Unknown option: $1"
            exit 1
            ;;
        *)
            TARGET="$1"
            shift
            ;;
    esac
done

# Validate flag combinations
if [[ "$ORCHESTRATOR" == "true" && "$PANE" == "true" ]]; then
    echo "Error: --orchestrator and --pane cannot be used together"
    exit 1
fi
if [[ "$PANE" == "true" && "$WITH_VIM" != "true" ]]; then
    echo "Error: --pane requires --vim"
    exit 1
fi

# Detect project structure (main/ structure or regular repo)
MODE=""
ROOT_DIR=""
MAIN_REPO=""

find_main_structure() {
    local dir="$PWD"
    while [[ "$dir" != "/" ]]; do
        if [[ -d "$dir/main/.git" ]]; then
            echo "$dir"
            return 0
        fi
        local parent="$(dirname "$dir")"
        if [[ -d "$parent/main/.git" ]]; then
            echo "$parent"
            return 0
        fi
        dir="$parent"
    done
    return 1
}

if ROOT_DIR="$(find_main_structure)"; then
    MODE="main-structure"
    MAIN_REPO="$ROOT_DIR/main"
else
    GIT_ROOT="$(git rev-parse --show-toplevel 2>/dev/null)" || {
        echo "Error: Not in a git repository"
        exit 1
    }

    if [[ -f "$GIT_ROOT/.git" ]]; then
        # This is a worktree - find the main repo
        MAIN_REPO="$(git -C "$GIT_ROOT" rev-parse --git-common-dir 2>/dev/null | sed 's/\.git$//' | sed 's/\/$//')"
        if [[ -z "$MAIN_REPO" || ! -d "$MAIN_REPO" ]]; then
            MAIN_REPO="$(cat "$GIT_ROOT/.git" | sed 's/gitdir: //' | sed 's/\.git\/worktrees.*//')"
        fi
        ROOT_DIR="$(dirname "$MAIN_REPO")"
    else
        MAIN_REPO="$GIT_ROOT"
        ROOT_DIR="$(dirname "$GIT_ROOT")"
    fi
    MODE="regular-repo"
fi

# Function to normalize branch name to directory name
branch_to_dir() {
    echo "$1" | sed -E 's/^(feat|fix|bug|chore|docs|style|refactor|perf|test|build|ci)\///' | tr '[:upper:]' '[:lower:]'
}

# Function to get branch name from worktree path
get_worktree_branch() {
    local path="$1"
    git -C "$MAIN_REPO" worktree list --porcelain | awk -v path="$path" '
        /^worktree / { wt = substr($0, 10) }
        /^branch / { if (wt == path) { sub(/^branch refs\/heads\//, ""); print; exit } }
    '
}

# Resolve target to WORKTREE_PATH
resolve_target() {
    local target="$1"

    # If no target, check if we're inside a worktree
    if [[ -z "$target" ]]; then
        local git_root="$(git rev-parse --show-toplevel 2>/dev/null || true)"

        if [[ -z "$git_root" ]]; then
            echo "Error: Not in a git repository and no target specified"
            return 1
        fi

        if [[ "$git_root" == "$MAIN_REPO" ]]; then
            echo "Error: You're in the main repository. Specify a worktree:"
            echo "  mise worktree:dev <branch-or-directory>"
            return 1
        fi

        WORKTREE_PATH="$git_root"
        return 0
    fi

    # Try to match as directory name first
    if [[ -d "$ROOT_DIR/$target" ]]; then
        WORKTREE_PATH="$ROOT_DIR/$target"
        return 0
    fi

    # Try to match as branch name (convert to dir name)
    local dir_name="$(branch_to_dir "$target")"
    if [[ -d "$ROOT_DIR/$dir_name" ]]; then
        WORKTREE_PATH="$ROOT_DIR/$dir_name"
        return 0
    fi

    # Search through worktrees for matching branch
    while IFS= read -r line; do
        if [[ "$line" =~ ^worktree\ (.+) ]]; then
            local wt_path="${BASH_REMATCH[1]}"
        elif [[ "$line" =~ ^branch\ refs/heads/(.+) ]]; then
            local wt_branch="${BASH_REMATCH[1]}"
            if [[ "$wt_branch" == "$target" ]]; then
                WORKTREE_PATH="$wt_path"
                return 0
            fi
        fi
    done < <(git -C "$MAIN_REPO" worktree list --porcelain)

    echo "Error: Could not find worktree for '$target'"
    echo "Run 'mise worktree:new $target' first to create it."
    return 1
}

# Handle --new flag: create worktree if it doesn't exist
if [[ "$NEW" == "true" ]]; then
    if [[ -z "$TARGET" ]]; then
        echo "Error: --new requires a branch name"
        echo "Usage: mise worktree:dev <branch> --new"
        exit 1
    fi

    # Try to resolve - if it succeeds, worktree already exists
    WORKTREE_PATH=""
    if resolve_target "$TARGET" &>/dev/null; then
        echo "Error: Worktree for '$TARGET' already exists"
        echo "Remove the --new flag to start a dev session on the existing worktree."
        exit 1
    fi

    # Worktree doesn't exist, create it
    echo "Creating new worktree for '$TARGET'..."
    mise worktree:new "$TARGET"
    echo ""
fi

WORKTREE_PATH=""
resolve_target "$TARGET" || exit 1

DIR_NAME="$(basename "$WORKTREE_PATH")"
BRANCH="$(get_worktree_branch "$WORKTREE_PATH")"

# Sanitize branch name for use in pane names (replace / with -)
BRANCH_SAFE="$(echo "$BRANCH" | tr '/' '-')"

# Generate prompt if --prompt flag was used but no value provided
if [[ "$USE_PROMPT" == "true" && -z "$PROMPT" ]]; then
    # Strip feat/, fix/, bug/, etc. prefixes and use as "Work on X"
    WORK_ON="$(echo "$BRANCH" | sed -E 's/^(feat|fix|bug|chore|docs|style|refactor|perf|test|build|ci)\///')"
    PROMPT="Work on ${WORK_ON}"
fi

# Store layouts in ~/.config/mise/layouts/ (not in worktree)
LAYOUTS_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/mise/layouts"
mkdir -p "$LAYOUTS_DIR"
LAYOUT_FILE="$LAYOUTS_DIR/${DIR_NAME}.kdl"

# Build extra args for KDL (must be quoted)
EXTRA_ARGS=""
EXTRA_ARGS_WITH_PROMPT=""
if [[ "$RESUME" == "true" ]]; then
    EXTRA_ARGS="${EXTRA_ARGS} \"--resume\""
    EXTRA_ARGS_WITH_PROMPT="${EXTRA_ARGS_WITH_PROMPT} \"--resume\""
fi
if [[ "$DANGEROUS" == "true" ]]; then
    EXTRA_ARGS="${EXTRA_ARGS} \"--dangerously-skip-permissions\""
    EXTRA_ARGS_WITH_PROMPT="${EXTRA_ARGS_WITH_PROMPT} \"--dangerously-skip-permissions\""
fi
if [[ -n "$AGENT" ]]; then
    EXTRA_ARGS="${EXTRA_ARGS} \"--agent\" \"${AGENT}\""
    EXTRA_ARGS_WITH_PROMPT="${EXTRA_ARGS_WITH_PROMPT} \"--agent\" \"${AGENT}\""
fi
# Only add prompt for non-resume mode (prompt is for fresh starts)
if [[ "$RESUME" != "true" && "$USE_PROMPT" == "true" && -n "$PROMPT" ]]; then
    # Escape double quotes in prompt for KDL
    ESCAPED_PROMPT="$(echo "$PROMPT" | sed 's/"/\\"/g')"
    EXTRA_ARGS_WITH_PROMPT="${EXTRA_ARGS_WITH_PROMPT} \"--prompt\" \"${ESCAPED_PROMPT}\""
fi

# Path to wrapper script (spawns nested zellij session)
CLAUDE_SESSION="${XDG_CONFIG_HOME:-$HOME/.config}/mise/bin/claude-session"

# Tab names (keep short - branch context is in session name)
VIM_TAB_NAME="vim"
CLAUDE_TAB_NAME="claude"

# Generate the layout KDL based on mode
if [[ "$WITH_VIM" == "true" ]]; then
    if [[ "$PANE" == "true" ]]; then
        # Single tab: vim (2/3) + claude (1/3) side-by-side
        PANE_NAME="claude-${BRANCH_SAFE}"

        cat > "$LAYOUT_FILE" << EOF
// Claude Development Layout (Vim + Claude Side-by-Side)
// Worktree: ${DIR_NAME}
// Branch: ${BRANCH}

layout {
    default_tab_template {
        pane size=1 borderless=true {
            plugin location="zellij:tab-bar"
        }
        children
        pane size=2 borderless=true {
            plugin location="zellij:status-bar"
        }
    }

    tab name="dev" {
        pane split_direction="vertical" {
            pane size="67%" {
                cwd "${WORKTREE_PATH}"
                command "nvim"
            }
            pane size="33%" name="${PANE_NAME}" {
                cwd "${WORKTREE_PATH}"
                command "${CLAUDE_SESSION}"
                args "${PANE_NAME}" ${EXTRA_ARGS_WITH_PROMPT}
            }
        }
    }
}
EOF
        PANE_INFO="Vim + Claude side-by-side (2/3 + 1/3)"
    elif [[ "$ORCHESTRATOR" == "true" ]]; then
        PANE1_NAME="claude-${BRANCH_SAFE}"
        PANE2_NAME="claude-${BRANCH_SAFE}-orchestrator"

        cat > "$LAYOUT_FILE" << EOF
// Claude Development Layout (Vim + Orchestrator Mode)
// Worktree: ${DIR_NAME}
// Branch: ${BRANCH}

layout {
    default_tab_template {
        pane size=1 borderless=true {
            plugin location="zellij:tab-bar"
        }
        children
        pane size=2 borderless=true {
            plugin location="zellij:status-bar"
        }
    }

    tab name="${VIM_TAB_NAME}" {
        pane {
            cwd "${WORKTREE_PATH}"
            command "nvim"
        }
    }

    tab name="${CLAUDE_TAB_NAME}" {
        pane split_direction="vertical" {
            pane name="${PANE1_NAME}" {
                cwd "${WORKTREE_PATH}"
                command "${CLAUDE_SESSION}"
                args "${PANE1_NAME}" ${EXTRA_ARGS_WITH_PROMPT}
            }
            pane name="${PANE2_NAME}" {
                cwd "${WORKTREE_PATH}"
                command "${CLAUDE_SESSION}"
                args "${PANE2_NAME}" ${EXTRA_ARGS}
            }
        }
    }
}
EOF
        PANE_INFO="Vim + Two Claude instances (orchestrator)"
    else
        PANE_NAME="claude-${BRANCH_SAFE}"

        cat > "$LAYOUT_FILE" << EOF
// Claude Development Layout (Vim Mode)
// Worktree: ${DIR_NAME}
// Branch: ${BRANCH}

layout {
    default_tab_template {
        pane size=1 borderless=true {
            plugin location="zellij:tab-bar"
        }
        children
        pane size=2 borderless=true {
            plugin location="zellij:status-bar"
        }
    }

    tab name="${VIM_TAB_NAME}" {
        pane {
            cwd "${WORKTREE_PATH}"
            command "nvim"
        }
    }

    tab name="${CLAUDE_TAB_NAME}" {
        pane name="${PANE_NAME}" {
            cwd "${WORKTREE_PATH}"
            command "${CLAUDE_SESSION}"
            args "${PANE_NAME}" ${EXTRA_ARGS_WITH_PROMPT}
        }
    }
}
EOF
        PANE_INFO="Vim + Single Claude instance"
    fi
else
    # No vim - just claude tab(s)
    if [[ "$ORCHESTRATOR" == "true" ]]; then
        PANE1_NAME="claude-${BRANCH_SAFE}"
        PANE2_NAME="claude-${BRANCH_SAFE}-orchestrator"

        cat > "$LAYOUT_FILE" << EOF
// Claude Development Layout (Orchestrator Mode)
// Worktree: ${DIR_NAME}
// Branch: ${BRANCH}

layout {
    default_tab_template {
        pane size=1 borderless=true {
            plugin location="zellij:tab-bar"
        }
        children
        pane size=2 borderless=true {
            plugin location="zellij:status-bar"
        }
    }

    tab name="${CLAUDE_TAB_NAME}" {
        pane split_direction="vertical" {
            pane name="${PANE1_NAME}" {
                cwd "${WORKTREE_PATH}"
                command "${CLAUDE_SESSION}"
                args "${PANE1_NAME}" ${EXTRA_ARGS_WITH_PROMPT}
            }
            pane name="${PANE2_NAME}" {
                cwd "${WORKTREE_PATH}"
                command "${CLAUDE_SESSION}"
                args "${PANE2_NAME}" ${EXTRA_ARGS}
            }
        }
    }
}
EOF
        PANE_INFO="Two Claude instances (implementer + orchestrator)"
    else
        PANE_NAME="claude-${BRANCH_SAFE}"

        cat > "$LAYOUT_FILE" << EOF
// Claude Development Layout
// Worktree: ${DIR_NAME}
// Branch: ${BRANCH}

layout {
    default_tab_template {
        pane size=1 borderless=true {
            plugin location="zellij:tab-bar"
        }
        children
        pane size=2 borderless=true {
            plugin location="zellij:status-bar"
        }
    }

    tab name="${CLAUDE_TAB_NAME}" {
        pane name="${PANE_NAME}" {
            cwd "${WORKTREE_PATH}"
            command "${CLAUDE_SESSION}"
            args "${PANE_NAME}" ${EXTRA_ARGS_WITH_PROMPT}
        }
    }
}
EOF
        PANE_INFO="Single Claude instance"
    fi
fi

echo "=========================================="
echo "  Claude Worktree Development"
echo "=========================================="
echo ""
echo "Worktree: $WORKTREE_PATH"
echo "Branch:   $BRANCH"
echo "Mode:     $PANE_INFO"
echo ""
echo "Press Ctrl+O then 'd' to detach from Zellij"
echo ""
echo "=========================================="
echo ""

# Launch with the layout
zellij --layout "$LAYOUT_FILE"
