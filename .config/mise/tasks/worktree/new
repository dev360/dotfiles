#!/usr/bin/env bash
#MISE description="Create a new git worktree with optional branch creation"
#MISE usage="worktree:new <branch> [-p <prefix>]"
set -euo pipefail

# Parse arguments
BRANCH=""
PREFIX=""

while [[ $# -gt 0 ]]; do
    case "$1" in
        -p|--prefix)
            PREFIX="$2"
            shift 2
            ;;
        -*)
            echo "Unknown option: $1"
            exit 1
            ;;
        *)
            BRANCH="$1"
            shift
            ;;
    esac
done

if [[ -z "$BRANCH" ]]; then
    echo "Error: Branch name is required"
    echo "Usage: mise worktree:new <branch-name> [-p <prefix>]"
    echo ""
    echo "Examples:"
    echo "  mise worktree:new feat/FLO-123           # Creates flo-123/"
    echo "  mise worktree:new feat/FLO-123 -p ui    # Creates ui-flo-123/"
    exit 1
fi

# Find the project root (parent of main/ directory)
find_project_root() {
    local dir="$PWD"
    while [[ "$dir" != "/" ]]; do
        # Check if we're in a worktree structure (sibling to main/)
        if [[ -d "$dir/main/.git" ]]; then
            echo "$dir"
            return 0
        fi
        # Check if parent has main/ sibling
        local parent="$(dirname "$dir")"
        if [[ -d "$parent/main/.git" ]]; then
            echo "$parent"
            return 0
        fi
        dir="$parent"
    done
    return 1
}

ROOT_DIR="$(find_project_root)" || {
    echo "Error: Could not find project root with main/ directory"
    echo "Expected structure:"
    echo "  project-root/"
    echo "    ├── main/      # Main git repository"
    echo "    ├── feature-1/ # Worktree"
    echo "    └── feature-2/ # Worktree"
    exit 1
}

MAIN_REPO="$ROOT_DIR/main"

cd "$MAIN_REPO"

# Strip semantic commit prefixes for directory name
# Supports: feat/, fix/, bug/, chore/, docs/, style/, refactor/, perf/, test/, build/, ci/
DIR_NAME=$(echo "$BRANCH" | sed -E 's/^(feat|fix|bug|chore|docs|style|refactor|perf|test|build|ci)\///')
# Convert to lowercase for directory name
DIR_NAME=$(echo "$DIR_NAME" | tr '[:upper:]' '[:lower:]')

# Add prefix if provided
if [[ -n "$PREFIX" ]]; then
    PREFIX=$(echo "$PREFIX" | tr '[:upper:]' '[:lower:]')
    DIR_NAME="${PREFIX}-${DIR_NAME}"
fi

WORKTREE_PATH="$ROOT_DIR/$DIR_NAME"

# Check if worktree already exists
if [[ -d "$WORKTREE_PATH" ]]; then
    echo "Error: Worktree directory already exists at $WORKTREE_PATH"
    exit 1
fi

# Fetch latest from origin to ensure we have branch info
echo "Fetching latest from origin..."
git fetch origin

# Check if branch exists (locally or remotely)
BRANCH_EXISTS=false
if git show-ref --verify --quiet "refs/heads/$BRANCH" 2>/dev/null; then
    BRANCH_EXISTS=true
    echo "Branch '$BRANCH' exists locally"
elif git show-ref --verify --quiet "refs/remotes/origin/$BRANCH" 2>/dev/null; then
    BRANCH_EXISTS=true
    echo "Branch '$BRANCH' exists on remote"
fi

# Create branch from main if it doesn't exist
if [[ "$BRANCH_EXISTS" == "false" ]]; then
    echo "Creating branch '$BRANCH' from main..."
    git branch "$BRANCH" origin/main
fi

# Create the worktree
echo "Creating worktree at $WORKTREE_PATH..."
git worktree add "$WORKTREE_PATH" "$BRANCH"

# Copy mise config to the new worktree if it exists in main
if [[ -d "$MAIN_REPO/.mise" ]]; then
    echo "Copying mise configuration..."
    cp -r "$MAIN_REPO/.mise" "$WORKTREE_PATH/.mise"
fi

echo ""
echo "Worktree created successfully!"
echo "  Branch: $BRANCH"
echo "  Path: $WORKTREE_PATH"
echo ""
echo "To start development with Claude, run:"
echo "  mise worktree:dev $BRANCH"
